name: Build & Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch: # Manual trigger for testing

permissions:
  contents: read

jobs:
  build-wheel:
    name: Build wheel (x86_64)
    runs-on: ubuntu-22.04
    container:
      image: nvidia/cuda:12.4.1-devel-ubuntu22.04

    steps:
      - name: Install system dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            git wget curl ca-certificates gnupg lsb-release \
            cmake ninja-build python3 python3-pip python3-venv \
            patchelf

          # LLVM 18, 19, 20 from apt.llvm.org
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | gpg --dearmor -o /usr/share/keyrings/llvm.gpg
          CODENAME=$(lsb_release -cs)
          for V in 18 19 20; do
            echo "deb [signed-by=/usr/share/keyrings/llvm.gpg] http://apt.llvm.org/$CODENAME/ llvm-toolchain-$CODENAME-$V main" \
              > /etc/apt/sources.list.d/llvm-$V.list
          done

          apt-get update
          apt-get install -y --no-install-recommends \
            llvm-18-dev clang-18 \
            llvm-19-dev clang-19 \
            llvm-20-dev clang-20

          # Rust via rustup
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

      - uses: actions/checkout@v4

      - name: Build wheel
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          # Need wheel>=0.40 for the 'tags' subcommand (Ubuntu ships 0.37)
          pip3 install build setuptools 'wheel>=0.40'
          bash scripts/build_wheel.sh

      - name: Retag wheel as manylinux
        run: |
          # Retag linux_x86_64 -> manylinux_2_28_x86_64
          # Our .so files are LLVM/CUDA plugins that use host libs, so we
          # don't auditwheel (which would try to bundle LLVM+CUDA = gigabytes).
          python3 -m wheel tags \
            --platform-tag manylinux_2_28_x86_64 \
            --remove dist/*.whl

      - name: Verify wheel contents
        run: |
          pip3 install dist/*.whl
          python3 -c "import prlx; print('Version:', prlx.__version__)"
          python3 -c "from prlx._find_lib import find_differ_binary; assert find_differ_binary(), 'prlx-diff not found'"
          python3 -c "from prlx._find_lib import find_pass_plugin; print('Pass:', find_pass_plugin())"
          prlx --help | head -5

      - uses: actions/upload-artifact@v4
        with:
          name: prlx-wheel-x86_64
          path: dist/*.whl

  # ---- Publish to PyPI on tagged releases ----
  publish:
    name: Publish to PyPI
    needs: build-wheel
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    environment: pypi
    permissions:
      id-token: write # Trusted publishing (no API tokens needed)

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: prlx-wheel-x86_64
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
