#!/usr/bin/env python3
"""
GPU DiffDbg Driver
==================
Main entry point for the GPU differential debugger toolkit.

This script orchestrates the workflow:
1. Compile CUDA kernels with automatic instrumentation
2. Run traces with proper environment setup
3. Invoke the differ with source location mapping

Usage:
    gddbg diff <trace_a> <trace_b> [options]    Compare two traces
    gddbg run <binary> [args]                   Run with tracing enabled
    gddbg check <binary> [args]                 Run twice and auto-diff
"""

import argparse
import os
import subprocess
import sys
from pathlib import Path
import tempfile


def find_site_map(search_dir=None):
    """
    Find the gddbg-sites.json file by searching common locations.

    Search order:
    1. Current directory
    2. Build directory
    3. Parent directories up to project root
    """
    if search_dir is None:
        search_dir = Path.cwd()
    else:
        search_dir = Path(search_dir)

    # Check current directory first
    candidates = [
        search_dir / "gddbg-sites.json",
        search_dir / "build" / "gddbg-sites.json",
        search_dir / ".." / "build" / "gddbg-sites.json",
    ]

    for candidate in candidates:
        if candidate.exists():
            return candidate.resolve()

    # Search parent directories
    current = search_dir
    for _ in range(5):  # Don't go too far up
        site_map = current / "gddbg-sites.json"
        if site_map.exists():
            return site_map.resolve()
        current = current.parent

    return None


def find_differ_binary():
    """Find the gddbg-diff binary."""
    # Try in the differ subdirectory
    script_dir = Path(__file__).parent
    differ_release = script_dir / "differ" / "target" / "release" / "gddbg-diff"
    differ_debug = script_dir / "differ" / "target" / "debug" / "gddbg-diff"

    if differ_release.exists():
        return differ_release
    if differ_debug.exists():
        return differ_debug

    # Try in PATH
    try:
        result = subprocess.run(["which", "gddbg-diff"], capture_output=True, text=True)
        if result.returncode == 0:
            return Path(result.stdout.strip())
    except:
        pass

    return None


def cmd_diff(args):
    """Run the differ on two trace files."""
    trace_a = Path(args.trace_a)
    trace_b = Path(args.trace_b)

    if not trace_a.exists():
        print(f"Error: Trace A not found: {trace_a}", file=sys.stderr)
        return 1
    if not trace_b.exists():
        print(f"Error: Trace B not found: {trace_b}", file=sys.stderr)
        return 1

    # Find the differ binary
    differ = find_differ_binary()
    if not differ:
        print("Error: gddbg-diff binary not found. Build with: cd differ && cargo build --release", file=sys.stderr)
        return 1

    # Find site map if not provided
    site_map = None
    if args.map:
        site_map = Path(args.map)
        if not site_map.exists():
            print(f"Warning: Site map not found: {site_map}", file=sys.stderr)
            site_map = None
    else:
        # Auto-detect site map
        site_map = find_site_map(trace_a.parent)
        if site_map:
            print(f"Auto-detected site map: {site_map}")
        else:
            print("Note: No site map found. Divergences will show site IDs only.")
            print("      To see source locations, provide --map gddbg-sites.json")

    # Build differ command
    cmd = [str(differ), str(trace_a), str(trace_b)]

    if site_map and site_map.exists():
        cmd.extend(["--map", str(site_map)])

    # Pass through other options
    if args.values:
        cmd.append("--values")
    if args.verbose:
        cmd.append("--verbose")
    if args.limit:
        cmd.extend(["--limit", str(args.limit)])
    if args.lookahead:
        cmd.extend(["--lookahead", str(args.lookahead)])
    if args.max_shown:
        cmd.extend(["-n", str(args.max_shown)])

    # Execute differ
    return subprocess.call(cmd)


def cmd_run(args):
    """Run a binary with tracing enabled."""
    binary = Path(args.binary)

    if not binary.exists():
        print(f"Error: Binary not found: {binary}", file=sys.stderr)
        return 1

    # Determine output trace file
    if args.output:
        trace_file = args.output
    else:
        trace_file = f"{binary.stem}.gddbg"

    # Set environment variable
    env = os.environ.copy()
    env["GDDBG_TRACE"] = trace_file

    print(f"Running {binary} with tracing enabled...")
    print(f"Trace output: {trace_file}")

    # Execute the binary
    cmd = [str(binary)] + args.binary_args
    result = subprocess.call(cmd, env=env)

    if result == 0 and Path(trace_file).exists():
        print(f"âœ“ Trace generated: {trace_file}")

    return result


def cmd_check(args):
    """Run a binary twice and automatically diff the traces."""
    binary = Path(args.binary)

    if not binary.exists():
        print(f"Error: Binary not found: {binary}", file=sys.stderr)
        return 1

    # Create temporary directory for traces
    with tempfile.TemporaryDirectory() as tmpdir:
        trace_a = Path(tmpdir) / "trace_a.gddbg"
        trace_b = Path(tmpdir) / "trace_b.gddbg"

        # Run first execution
        print("=== Run A ===")
        env = os.environ.copy()
        env["GDDBG_TRACE"] = str(trace_a)
        cmd = [str(binary)] + args.binary_args
        result_a = subprocess.call(cmd, env=env)

        if result_a != 0:
            print(f"Error: Run A failed with exit code {result_a}", file=sys.stderr)
            return result_a

        if not trace_a.exists():
            print("Error: Run A did not generate a trace file", file=sys.stderr)
            return 1

        # Run second execution
        print("\n=== Run B ===")
        env["GDDBG_TRACE"] = str(trace_b)
        result_b = subprocess.call(cmd, env=env)

        if result_b != 0:
            print(f"Error: Run B failed with exit code {result_b}", file=sys.stderr)
            return result_b

        if not trace_b.exists():
            print("Error: Run B did not generate a trace file", file=sys.stderr)
            return 1

        # Run diff
        print("\n=== Differential Analysis ===")

        # Create args object for cmd_diff
        class DiffArgs:
            def __init__(self):
                self.trace_a = trace_a
                self.trace_b = trace_b
                self.map = args.map
                self.values = args.values
                self.verbose = args.verbose
                self.limit = args.limit
                self.lookahead = args.lookahead
                self.max_shown = args.max_shown

        diff_args = DiffArgs()
        return cmd_diff(diff_args)


def main():
    parser = argparse.ArgumentParser(
        description="GPU DiffDbg - Differential debugger for CUDA kernels",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Compare two traces
  gddbg diff trace_a.gddbg trace_b.gddbg

  # Compare with source location mapping
  gddbg diff trace_a.gddbg trace_b.gddbg --map gddbg-sites.json

  # Run a binary with tracing
  gddbg run ./my_kernel --output my_trace.gddbg

  # Run twice and auto-diff
  gddbg check ./my_kernel
        """
    )

    subparsers = parser.add_subparsers(dest="command", help="Command to run")

    # diff command
    parser_diff = subparsers.add_parser("diff", help="Compare two trace files")
    parser_diff.add_argument("trace_a", help="First trace file (baseline)")
    parser_diff.add_argument("trace_b", help="Second trace file (compare)")
    parser_diff.add_argument("--map", help="Site mapping file (gddbg-sites.json)")
    parser_diff.add_argument("-n", "--max-shown", type=int, default=10, help="Max divergences to display")
    parser_diff.add_argument("--values", action="store_true", help="Compare operand values")
    parser_diff.add_argument("-v", "--verbose", action="store_true", help="Verbose output")
    parser_diff.add_argument("-l", "--limit", type=int, help="Max divergences to collect")
    parser_diff.add_argument("--lookahead", type=int, help="Lookahead window size")

    # run command
    parser_run = subparsers.add_parser("run", help="Run a binary with tracing enabled")
    parser_run.add_argument("binary", help="Binary to execute")
    parser_run.add_argument("-o", "--output", help="Output trace file")
    parser_run.add_argument("binary_args", nargs="*", help="Arguments to pass to binary")

    # check command
    parser_check = subparsers.add_parser("check", help="Run twice and auto-diff")
    parser_check.add_argument("binary", help="Binary to execute")
    parser_check.add_argument("--map", help="Site mapping file (gddbg-sites.json)")
    parser_check.add_argument("-n", "--max-shown", type=int, default=10, help="Max divergences to display")
    parser_check.add_argument("--values", action="store_true", help="Compare operand values")
    parser_check.add_argument("-v", "--verbose", action="store_true", help="Verbose output")
    parser_check.add_argument("-l", "--limit", type=int, help="Max divergences to collect")
    parser_check.add_argument("--lookahead", type=int, help="Lookahead window size")
    parser_check.add_argument("binary_args", nargs="*", help="Arguments to pass to binary")

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        return 1

    if args.command == "diff":
        return cmd_diff(args)
    elif args.command == "run":
        return cmd_run(args)
    elif args.command == "check":
        return cmd_check(args)
    else:
        parser.print_help()
        return 1


if __name__ == "__main__":
    sys.exit(main())
